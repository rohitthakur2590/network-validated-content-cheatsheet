= Network Bgp Validated Content Cheat Sheet
:experimental: true
:product-name: Network Validated Content Cheat Sheet

Ansible Network Bgp Validated content comprises YAML content, ansible roles, playbooks, etc, It is focuses on Bgp networking use cases.

The following section describe the command and tasks that are basic to using Network Bgp Validated Content.

The `list` task provide the list of supported resource modules.

The `gather` task provide the running-configuration as facts.

The `persist` task fetch the running-configuration as facts and save these facts as host-vars for autogenerated run-time inventory.

The `deploy` task read the facts saved as host-vars in inventory and deploy them on to the appliance.

The `health_checks` task is used to perform the health-checks on the specific service.


== Run list task

The following section describe the task to fetch the supported resource modules for the platform.

=== list

----
ansible.builtin.include_role:
      name: network.bgp.run
    vars:
      actions:
        - name: list
----

*Examples:*

*Get list of supported resource modules for ios operating system*

The play would look like following:
----
---
- hosts: ios
  tasks:
  - name: Get List of supported resource modules
    ansible.builtin.include_role:
      name:  network.bgp.run
    vars:
      actions:
        - name: list

$ ansible-playbook -i inventory.yaml list.yml 

TASK [../../base/roles/resource_manager : Available Network resources] *************************************************
ok: [35.155.13.92] => {
    "msg": {
        "ansible_connection": "ansible.netcommon.network_cli",
        "ansible_network_os": "cisco.ios.ios",
        "changed": false,
        "failed": false,
        "modules": [
            "acl_interfaces",
            "acls",
            "bgp_address_family",
            "bgp_global",
            "hostname",
            "interfaces",
            "l2_interfaces",
            "l3_interfaces",
            "lacp",
            "lacp_interfaces",
            "lag_interfaces",
            "lldp_global",
            "lldp_interfaces",
            "logging_global",
            "ntp_global",
            "ospf_interfaces",
            "ospfv2",
            "ospfv3",
            "prefix_lists",
            "route_maps",
            "snmp_server",
            "static_routes",
            "vlans"
        ]
    }
}
----

== Run persist task

The following section describe the task to fetch running bgp config and persist that.

=== persist

----
ansible.builtin.include_role:
      name: network.bgp.run
    vars:
      actions:
        - name: persist
----

*Examples:*

*Create brownfield inventory*

This task would fetch the running config and save the facts in terms of host vars on provided/default inventory path.This inventory could act as SOT for other operations 

The play would look like following:
----
---
- hosts: ios
  tasks:
  - name: Create run time inventory with host-vars(Facts).
    ansible.builtin.include_role:
      name:  network.bgp.run
    vars:
      actions:
        -name: persist

$ ansible-playbook -i inventory.yaml persist.yml 
$ tree inventory
inventory
├── host_vars
│   └── 35.155.113.92
│       ├── bgp_address_family.yaml
│       └── bgp_global.yaml
└── inventory.yaml

$ cat inventory/host_vars/35.155.113.92/bgp_global.yaml 
bgp_global:
    as_number: '500'
    bgp:
        log_neighbor_changes: true
    neighbors:
    -   neighbor_address: 12.0.0.1
        remote_as: '500'
        update_source: Loopback0
    -   neighbor_address: 23.0.0.1
        remote_as: '500'
    networks:
    -   address: 10.0.0.0
----

== Run deploy task

The following section describe the task to deploy network bgp configuration.

=== deploy

----
ansible.builtin.include_role:
      name: network.bgp.run
    vars:
      actions:
        - name: deploy
----

*Examples:*

*Deploy Configuration*

This task would read the host vars at run time from the invenotry we created with persist and will deploy those configuration changes on the network.In example below we have added one network.
----
$ vi inventory/host_vars/35.155.113.92/bgp_global.yaml 
bgp_global:
    as_number: '500'
    bgp:
        log_neighbor_changes: true
    neighbors:
    -   neighbor_address: 12.0.0.1
        remote_as: '500'
        update_source: Loopback0
    -   neighbor_address: 23.0.0.1
        remote_as: '500'
    networks:
    -   address: 10.0.0.0
    -   address: 80.0.0.0

---
- hosts: ios
  tasks:
  - name: Deploy configuration
    ansible.builtin.include_role:
      name:  network.bgp.run
    vars:
      actions:
        name: deploy

$ ansible-playbook deploy.yml
.
.
.
TASK [network.base.resource_manager : Include tasks] 
************************************************************************************************************************
included: /home/rothakur/ansible-collections/collections/ansible_collections/network/base/roles/resource_manager/includes/edit_resource.yaml for 35.155.113.92

TASK [network.base.resource_manager : Apply provided configuration] *********************************************************************************************************
changed: [35.155.113.92]

TASK [network.base.resource_manager : Apply configuration] ******************************************************************************************************************
skipping: [35.155.113.92]

PLAY RECAP ******************************************************************************************************************************************************************
35.155.113.92              : ok=16   changed=1    unreachable=0    failed=0    skipped=3    rescued=0    ignored=0   

----

== Run gather task

The following section describe the task to gather running bgp specific configuration.

=== gather

----
ansible.builtin.include_role:
      name: network.bgp.run
    vars:
      actions:
        - name: gather
----

*Examples:*

*Gather Configuration*

This task would gather the running bgp_global and bgp_address_family configuration from the network and display on the terminal.
----
---
- hosts: ios
  tasks:
  - name: Gather network bgp configuration
    ansible.builtin.include_role:
      name:  network.bgp.run
    vars:
      actions:
        - name: gather

$ ansible-playbook gather.yml
.
.
.
TASK [network.base.resource_manager : Resource Facts] ***********************************************************************************************************************
ok: [35.155.113.92] => {
    "msg": {
        "ansible_connection": "ansible.netcommon.network_cli",
        "ansible_network_os": "cisco.ios.ios",
        "changed": false,
        "failed": false,
        "gathered": {
            "as_number": "500"
        },
        "resource_module_name": "cisco.ios.ios_bgp_address_family"
    }
}

TASK [network.base.resource_manager : Include file write task] **************************************************************************************************************
skipping: [35.155.113.92]

TASK [network.base.resource_manager : Run the platform facts module] ********************************************************************************************************
ok: [35.155.113.92]

TASK [network.base.resource_manager : Resource Facts] ***********************************************************************************************************************
ok: [35.155.113.92] => {
    "msg": {
        "ansible_connection": "ansible.netcommon.network_cli",
        "ansible_network_os": "cisco.ios.ios",
        "changed": false,
        "failed": false,
        "gathered": {
            "as_number": "500",
            "bgp": {
                "log_neighbor_changes": true
            },
            "neighbors": [
                {
                    "neighbor_address": "12.0.0.1",
                    "remote_as": "500",
                    "update_source": "Loopback0"
                },
                {
                    "neighbor_address": "23.0.0.1",
                    "remote_as": "500"
                }
            ],
            "networks": [
                {
                    "address": "10.0.0.0"
                },
                {
                    "address": "80.0.0.0"
                }
            ]
        },
        "resource_module_name": "cisco.ios.ios_bgp_global"
    }
}

We can also notice our latest config change `address: 80.0.0.0` which we did with deploy.

----
== Run health_check task

The following section describe the task to gather running bgp specific configuration.

=== health_check

----
ansible.builtin.include_role:
      name: network.bgp.run
    vars:
      actions:
        - name: health_checks
          vars:
              checks:
                - name: all_neighbors_up
                - name: all_neighbors_down
                - name: min_neighbors_up
                  min_count: 1
----

*Examples:*

*Perform Network Bgp Health Checks*

This task enables user to perform certain network bgp healt-checks as mentioned below:

`all_neighbors_up`: This health-check returns `successful`` only when all the bgp neighbors are up and running.

`all_neighbors_down`: This health-check returns `successful` only when all the neighbors are down.

`min_neighbors_up`: This health-check takes `min_count` as input and returns `successful` only when that much number of neighbors are up and running

----

---
- hosts: ios
  gather_facts: false
  tasks:
    - name: Perform BGP Health Checks
      ansible.builtin.include_role:
        name: network.bgp.run
      vars:
        actions:
          - name: health_check
            vars:
              checks:
                - name: all_neighbors_up
                - name: all_neighbors_down
                - name: min_neighbors_up
                  min_count: 1

$ ansible-playbook  health_check.yml
.
.
.
TASK [network.bgp.run : Set health checks fact] *********************************************************************************************************************
ok: [35.155.113.92]

TASK [network.bgp.run : BGP health checks] *********************************************************************************************************************
ok: [35.155.113.92] => {
    "health_checks": {
        "all_neighbors_down": {
            "check_status": "successful",
            "down": 2,
            "total": 2,
            "up": 0
        },
        "all_neighbors_up": {
            "check_status": "failed",
            "down": 2,
            "total": 2,
            "up": 0
        },
        "min_neighbors_up": {
            "check_status": "failed",
            "down": 2,
            "total": 2,
            "up": 0
        }
    }
}

PLAY RECAP *********************************************************************************************************************
35.155.113.92              : ok=5    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

We can also use `details` to get the detailed stats for performed healthchecks as shown below 

---
- hosts: ios
  gather_facts: false
  tasks:
    - name: Perform BGP Health Checks
      ansible.builtin.include_role:
        name: network.bgp.run
      vars:
        actions:
          - name: health_check
            vars:
              details: true
              checks:
                - name: all_neighbors_up
                - name: all_neighbors_down
                - name: min_neighbors_up
                  min_count: 1

$ ansible-playbook  health_check.yml

ok: [35.155.113.92] => {
    "health_checks": {
        "all_neighbors_down": {
            "check_status": "successful",
            "details": {
                "neighbors": [
                    {
                        "bgp_table_version": 1,
                        "input_queue": 0,
                        "msg_rcvd": 0,
                        "msg_sent": 0,
                        "output_queue": 0,
                        "peer": "12.0.0.1",
                        "peer_as": 500,
                        "peer_state": "Idle",
                        "uptime": "13w4d",
                        "version": 4
                    },
                    {
                        "bgp_table_version": 1,
                        "input_queue": 0,
                        "msg_rcvd": 0,
                        "msg_sent": 0,
                        "output_queue": 0,
                        "peer": "23.0.0.1",
                        "peer_as": 500,
                        "peer_state": "Idle",
                        "uptime": "never",
                        "version": 4
                    }
                ]
            },
            "down": 2,
            "total": 2,
            "up": 0
        },
        "all_neighbors_up": {
            "check_status": "failed",
            "details": {
                "neighbors": []
            },
            "down": 2,
            "total": 2,
            "up": 0
        },
        "min_neighbors_up": {
            "check_status": "failed",
            "details": {
                "neighbors": []
            },
            "down": 2,
            "total": 2,
            "up": 0
        }
    }
}

----
